@page "{slug?}"
@model DotNetUniverse.Pages.Years.EventModel
@using DotNetUniverse.Services
@using DotNetUniverse.Services.YearData
@using DotNetUniverse.Models.Collections
@inject SessionDisplayService SessionDisplay
@{
    var yearData = Model.YearData;
    var evt = yearData.Event;
    var speakers = yearData.Speakers;
    var sessions = evt.AllSessions;
    var themeColor = yearData.ThemeColor;
    var themeColorClass = yearData.ThemeColorClass;
}

<!-- 히어로 섹션 -->
<section class="hero-section" style="@(evt.HasHeroImage ? $"background-image: url('{evt.ResolvedHeroImageUrl}'); background-size: cover; background-position: center;" : $"background: linear-gradient(135deg, {themeColor} 0%, {themeColor}cc 100%);")">
    <div class="hero-overlay" style="background: rgba(0,0,0,0.5);"></div>
    <div class="container position-relative">
        <div class="row min-vh-75 align-items-center py-5">
            <div class="col-lg-8 mx-auto text-center text-white">
                @if (evt.IsUpcoming)
                {
                    <div class="badge bg-warning text-dark fs-6 mb-3 px-3 py-2">
                        <i class="bi bi-calendar-event me-2"></i>예정된 행사
                    </div>
                }
                else
                {
                    <div class="badge bg-success fs-6 mb-3 px-3 py-2">
                        <i class="bi bi-check-circle me-2"></i>종료된 행사
                    </div>
                }
                <h1 class="display-2 fw-bold mb-4">
                    @evt.Title
                </h1>
                <p class="lead mb-4 opacity-90">
                    @evt.Theme
                </p>
                <div class="hero-info d-flex flex-wrap justify-content-center gap-4 mb-5">
                    <div class="info-item">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span>@evt.Date.ToString("yyyy년 M월 d일")</span>
                    </div>
                    @if (evt.Type != EventType.Online && evt.IsUpcoming && evt.PrimaryVenue != null)
                    {
                        <div class="info-item">
                            <i class="bi bi-geo-alt me-2"></i>
                            <span>@evt.PrimaryVenue.Name</span>
                        </div>
                    }
                    @if (evt.AttendeeCount.HasValue)
                    {
                        <div class="info-item">
                            <i class="bi bi-people-fill me-2"></i>
                            <span>@evt.AttendeeCount+ 참가</span>
                        </div>
                    }
                </div>
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    @if (evt.IsUpcoming && yearData.Schedule != null)
                    {
                        <a href="#timetable" class="btn btn-light btn-lg px-5 py-3">
                            <i class="bi bi-calendar3 me-2"></i>시간표
                        </a>
                    }
                    <a href="#sessions" class="btn btn-outline-light btn-lg px-4 py-3">
                        <i class="bi bi-play-circle me-2"></i>세션 보기
                    </a>
                    @if (yearData.Story != null)
                    {
                        <a href="#story" class="btn btn-outline-light btn-lg px-4 py-3">
                            <i class="bi bi-book me-2"></i>스토리
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 트레일러 영상 -->
@if (evt.HasTrailer)
{
    <section class="py-5" id="trailer">
        <div class="container py-4">
            <div class="text-center mb-5">
                <h2 class="fw-bold display-5 mb-3">행사 영상</h2>
                <p class="text-muted lead">@evt.Title 하이라이트</p>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="ratio ratio-16x9 shadow-lg rounded overflow-hidden">
                        @if (evt.IsYouTubeTrailer)
                        {
                            <iframe src="@evt.YouTubeEmbedUrl" 
                                    title="@evt.Title 트레일러"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                    allowfullscreen></iframe>
                        }
                        else
                        {
                            <video controls preload="metadata" poster="/images/events/@(evt.Year)-poster.webp">
                                <source src="@evt.TrailerUrl" type="video/mp4">
                                브라우저가 비디오 재생을 지원하지 않습니다.
                            </video>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>
}

<!-- 행사 하이라이트 -->
<section class="py-5">
    <div class="container py-5">
        <div class="text-center mb-5">
            <h2 class="fw-bold display-5 mb-3">행사 하이라이트</h2>
            <p class="text-muted lead">@evt.Title</p>
        </div>
        <div class="row g-4 text-center">
            <div class="col-6 col-md-3">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body p-4">
                        <div class="display-4 fw-bold text-@themeColorClass mb-2">@(evt.AttendeeCount)+</div>
                        <p class="text-muted mb-0">참가자</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body p-4">
                        <div class="display-4 fw-bold text-@themeColorClass mb-2">@sessions.Count()</div>
                        <p class="text-muted mb-0">세션</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body p-4">
                        <div class="display-4 fw-bold text-@themeColorClass mb-2">@speakers.Count</div>
                        <p class="text-muted mb-0">연사</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card border-0 bg-light h-100">
                    <div class="card-body p-4">
                        <div class="display-4 fw-bold text-@themeColorClass mb-2">@evt.Sponsors.Count</div>
                        <p class="text-muted mb-0">스폰서</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 시간표 (예정된 행사이고 ScheduleGrid가 있는 경우에만) -->
@{
    var scheduleGrid = yearData.Schedule;
    var hasSchedule = scheduleGrid != null && evt.IsUpcoming;
}
@if (hasSchedule)
{
    var grid = scheduleGrid!;

    <section class="py-5 bg-light" id="timetable">
        <div class="container py-4">
            <div class="text-center mb-5">
                <h2 class="fw-bold display-5 mb-3">시간표</h2>
                <p class="text-muted lead">트랙별 세션 일정을 한눈에 확인하세요</p>
            </div>
            
            <div class="mb-5">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle timetable-table">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center" style="width: 100px; min-width: 100px;">
                                    <i class="bi bi-clock me-1"></i>시간
                                </th>
                                @foreach (var column in grid.Columns)
                                {
                                    <th class="text-center" style="min-width: 250px;">
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold">@column.Name</span>
                                            @if (!string.IsNullOrEmpty(column.Description))
                                            {
                                                <small class="opacity-75">@column.Description</small>
                                            }
                                        </div>
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in grid.Rows)
                            {
                                <tr>
                                    <td class="text-center fw-bold bg-light">
                                        @row.TimeSlot.StartTime.ToString("HH:mm")
                                    </td>
                                    
                                    @for (int i = 0; i < row.Cells.Length; i++)
                                    {
                                        var cell = row.Cells[i];
                                        var columnColor = i < grid.Columns.Length ? grid.Columns[i].Color : null;
                                        var trackColor = columnColor ?? themeColor;
                                        
                                        @if (cell.IsHidden)
                                        {
                                            // rowspan/colspan에 의해 숨겨진 셀은 렌더링하지 않음
                                            continue;
                                        }
                                        else if (!cell.HasSession)
                                        {
                                            <td class="text-center text-muted bg-light">
                                                <small>-</small>
                                            </td>
                                        }
                                        else
                                        {
                                            var session = cell.Session!;
                                            var formatInfo = SessionDisplay.GetFormatDisplayInfo(session.Format);
                                            var isShared = cell.ColSpan > 1;
                                            var cellColor = isShared ? themeColor : trackColor;
                                            
                                            <td colspan="@cell.ColSpan" rowspan="@cell.RowSpan" class="p-0 @(isShared ? "text-center" : "")" style="border-left: 4px solid @cellColor;">
                                                <div class="timetable-session @(isShared ? "timetable-shared-session" : "") p-3 h-100"
                                                     @if (session.Speakers.Length > 0 || !isShared)
                                                     {
                                                         <text>role="button" data-bs-toggle="modal" data-bs-target="#@session.ModalId" style="cursor: pointer;"</text>
                                                     }>
                                                    <div class="d-flex @(isShared ? "justify-content-center" : "justify-content-between") align-items-@(isShared ? "center" : "start") @(isShared ? "gap-3" : "") mb-2">
                                                        <span class="badge bg-@formatInfo.BadgeColor @(isShared ? "fs-6" : "")">
                                                            @if (isShared)
                                                            {
                                                                <i class="bi @formatInfo.IconClass me-1"></i>
                                                            }
                                                            @formatInfo.DisplayName
                                                        </span>
                                                        <span class="text-muted @(isShared ? "" : "small")">@((int)session.Duration.TotalMinutes)분</span>
                                                    </div>
                                                    @if (isShared)
                                                    {
                                                        <h5 class="fw-bold mb-0">@session.Title</h5>
                                                    }
                                                    else
                                                    {
                                                        <h6 class="fw-bold mb-2 timetable-session-title">@session.Title</h6>
                                                    }
                                                    @if (session.Speakers.Length > 0)
                                                    {
                                                        var maxSpeakers = isShared ? 4 : 2;
                                                        <div class="d-flex @(isShared ? "justify-content-center" : "") align-items-center flex-wrap gap-@(isShared ? "2" : "1") @(isShared ? "mt-2" : "")">
                                                            @foreach (var speaker in session.Speakers.Take(maxSpeakers))
                                                            {
                                                                <div class="d-flex align-items-center @(isShared ? "" : "me-2")">
                                                                    <div class="speaker-avatar-wrapper me-1" style="width: 24px; height: 24px;">
                                                                        <img src="@speaker.ResolvedImageUrl" 
                                                                             alt="@speaker.Name" 
                                                                             class="speaker-avatar rounded-circle w-100 h-100 object-fit-cover"
                                                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                                                        <div class="avatar-placeholder bg-@themeColorClass text-white" style="display: none; width: 100%; height: 100%; font-size: 0.6rem;">
                                                                            <i class="bi bi-person-fill"></i>
                                                                        </div>
                                                                    </div>
                                                                    <small class="text-muted">@speaker.Name</small>
                                                                </div>
                                                            }
                                                            @if (session.Speakers.Length > maxSpeakers)
                                                            {
                                                                <small class="text-muted">외 @(session.Speakers.Length - maxSpeakers)명</small>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            </td>
                                        }
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <p class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    세션을 클릭하면 상세 정보를 확인할 수 있습니다
                </p>
            </div>
        </div>
    </section>
}

<!-- 세션 목록 -->
<section class="py-5" id="sessions">
    <div class="container py-4">
        @{
            var sessionGrid = yearData.Schedule;
            var isMultiDay = sessionGrid?.IsMultiDay == true;
            var presentationSessions = sessions.Where(s => s.IsPresentationSession);
        }
        <div class="text-center mb-5">
            <h2 class="fw-bold display-5 mb-3">세션</h2>
            <p class="text-muted lead">@(presentationSessions.Count() + "개의") 세션이 @(evt.IsUpcoming ? "예정되어 있습니다" : "진행되었습니다")</p>
        </div>
        
        @if (isMultiDay)
        {
            // 다중 Day 행사: Day별로 그룹화하여 표시 (발표 세션만)
            foreach (var dayGroup in sessionGrid!.PresentationSessionsByDay)
            {
                <div class="mb-5">
                    <h3 class="fw-bold mb-4 pb-2 border-bottom">
                        <i class="bi bi-calendar-event me-2 text-@themeColorClass"></i>Day @dayGroup.Key
                    </h3>
                    <div class="row g-4">
                        @foreach (var session in dayGroup)
                        {
                            @await Html.PartialAsync("_SessionCard", session, new ViewDataDictionary(ViewData) { { "themeColorClass", themeColorClass } })
                        }
                    </div>
                </div>
            }
        }
        else
        {
            // 단일 Day 행사: 기존 방식으로 표시 (발표 세션만)
            <div class="row g-4">
                @foreach (var session in presentationSessions)
                {
                    @await Html.PartialAsync("_SessionCard", session, new ViewDataDictionary(ViewData) { { "themeColorClass", themeColorClass } })
                }
            </div>
        }
    </div>
</section>

<!-- 세션 상세 모달들 -->
@foreach (var session in presentationSessions)
{
    var trackInfo = SessionDisplay.GetFormatDisplayInfo(session.Format);
    <div class="modal fade" id="@session.ModalId" tabindex="-1" aria-labelledby="@(session.ModalId)-label" aria-hidden="true"
         data-session-hash="session-@session.Id">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <span class="badge bg-@trackInfo.BadgeColor me-2">@trackInfo.DisplayName</span>
                        <span class="text-muted small">@(session.Duration.TotalMinutes)분</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body pt-2">
                    <h4 class="fw-bold mb-3" id="@(session.ModalId)-label">@session.Title</h4>
                    
                    @if (session.HasSchedule)
                    {
                        <div class="mb-4 d-flex flex-wrap gap-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-event text-primary me-2"></i>
                                <span class="small">Day @session.Schedule!.Day</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-clock text-primary me-2"></i>
                                <span class="small">@session.Schedule.StartTime.ToString("HH:mm")</span>
                            </div>
                        </div>
                    }
                    
                    <div class="mb-4">
                        <h6 class="text-muted mb-2"><i class="bi bi-person-fill me-1"></i>발표자</h6>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var speaker in session.Speakers)
                            {
                                <a href="?speaker=@speaker.Id" class="d-flex align-items-center bg-light rounded-pill px-3 py-2 text-decoration-none speaker-link">
                                    <div class="speaker-avatar-wrapper me-2" style="width: 28px; height: 28px;">
                                        <img src="@speaker.ResolvedImageUrl" 
                                             alt="@speaker.Name" 
                                             class="speaker-avatar rounded-circle w-100 h-100 object-fit-cover"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                        <div class="avatar-placeholder bg-@themeColorClass text-white" style="display: none; width: 100%; height: 100%; font-size: 0.7rem;">
                                            <i class="bi bi-person-fill"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <small class="fw-bold text-dark">@speaker.Name</small>
                                        @if (!string.IsNullOrEmpty(speaker.Company))
                                        {
                                            <small class="text-muted ms-1">(@speaker.Company)</small>
                                        }
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="text-muted mb-2"><i class="bi bi-file-text me-1"></i>세션 소개</h6>
                        <p class="mb-0" style="white-space: pre-line;">@session.Abstract.Trim()</p>
                    </div>
                    
                    @if (session.Tags != null)
                    {
                        <div class="mb-4">
                            <h6 class="text-muted mb-2"><i class="bi bi-tags me-1"></i>태그</h6>
                            <div>
                                @foreach (var tag in session.Tags)
                                {
                                    <span class="badge bg-light text-dark me-1 mb-1">@tag</span>
                                }
                            </div>
                        </div>
                    }
                    
                    @if (session.HasPrerequisites)
                    {
                        <div class="alert alert-warning mb-4">
                            <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-1"></i>사전 요구 사항</h6>
                            <p class="mb-0" style="white-space: pre-line;">@session.Prerequisites!.Trim()</p>
                        </div>
                    }
                    
                    @if (session.HasLabModules)
                    {
                        <div class="mb-4">
                            <h6 class="text-muted mb-2"><i class="bi bi-journal-code me-1"></i>실습 모듈</h6>
                            <div class="list-group">
                                @foreach (var module in session.LabModules!)
                                {
                                    <a href="@module.Url" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-box-arrow-up-right me-2 text-primary"></i>
                                            <span class="fw-bold">@module.Title</span>
                                            @if (!string.IsNullOrEmpty(module.Description))
                                            {
                                                <small class="text-muted d-block ms-4">@module.Description</small>
                                            }
                                        </div>
                                        <i class="bi bi-chevron-right text-muted"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                    
                    @if (session.HasNotes)
                    {
                        <div class="alert alert-info mb-0">
                            <h6 class="alert-heading"><i class="bi bi-info-circle me-1"></i>운영 안내</h6>
                            <ul class="mb-0 ps-3">
                                @foreach (var note in session.Notes!)
                                {
                                    <li>@note</li>
                                }
                            </ul>
                        </div>
                    }
                    @if (session.IsYouTubeVideo)
                    {
                        <div class="mb-4">
                            <h6 class="text-muted mb-2"><i class="bi bi-play-circle me-1"></i>세션 영상</h6>
                            <div class="ratio ratio-16x9 rounded overflow-hidden">
                                <iframe src="@session.YouTubeEmbedUrl" 
                                        title="@session.Title"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                        allowfullscreen></iframe>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary btn-copy-link" data-session-hash="@session.AnchorHash">
                        <i class="bi bi-link-45deg me-1"></i>링크 복사
                    </button>
                    @if (!string.IsNullOrEmpty(session.VideoUrl) && !session.IsYouTubeVideo)
                    {
                        <a href="@session.VideoUrl" class="btn btn-@themeColorClass" target="_blank">
                            <i class="bi bi-play me-1"></i>영상 보기
                        </a>
                    }
                    @if (!string.IsNullOrEmpty(session.SlidesUrl))
                    {
                        <a href="@session.SlidesUrl" class="btn btn-outline-@themeColorClass" target="_blank">
                            <i class="bi bi-download me-1"></i>자료 다운로드
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- 연사 섹션 -->
<section class="py-5" id="speakers">
    <div class="container py-4">
        <div class="text-center mb-5">
            <h2 class="fw-bold display-5 mb-3">연사진</h2>
            <p class="text-muted lead">@(evt.IsUpcoming ? "함께할 연사들" : "국내외 .NET 전문가들이 함께했습니다")</p>
        </div>
        <div class="row g-4 justify-content-center">
            @foreach (var speaker in speakers.Take(8))
            {
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="card border-0 shadow-sm h-100 card-hover" 
                         role="button" data-bs-toggle="modal" data-bs-target="#@speaker.ModalId"
                         style="cursor: pointer;">
                        <div class="card-body text-center p-4">
                            <div class="speaker-avatar-wrapper mx-auto mb-3" style="width: 80px; height: 80px;">
                                <img src="@speaker.ResolvedImageUrl" 
                                     alt="@speaker.Name" 
                                     class="speaker-avatar rounded-circle w-100 h-100 object-fit-cover"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                <div class="avatar-placeholder bg-@themeColorClass text-white" style="display: none; width: 100%; height: 100%;">
                                    <i class="bi bi-person-fill fs-1"></i>
                                </div>
                            </div>
                            <h6 class="fw-bold mb-1">@speaker.Name</h6>
                            <small class="text-muted d-block">@speaker.Title</small>
                            @if (!string.IsNullOrEmpty(speaker.Company))
                            {
                                <small class="text-@themeColorClass">@speaker.Company</small>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
        @if (speakers.Count > 8)
        {
            <div class="text-center mt-4">
                <button class="btn btn-outline-@themeColorClass" data-bs-toggle="collapse" data-bs-target="#more-speakers">
                    <i class="bi bi-chevron-down me-1"></i>더 보기 (@(speakers.Count - 8)명)
                </button>
            </div>
            <div class="collapse mt-4" id="more-speakers">
                <div class="row g-4 justify-content-center">
                    @foreach (var speaker in speakers.Skip(8))
                    {
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="card border-0 shadow-sm h-100 card-hover" 
                                 role="button" data-bs-toggle="modal" data-bs-target="#@speaker.ModalId"
                                 style="cursor: pointer;">
                                <div class="card-body text-center p-4">
                                    <div class="speaker-avatar-wrapper mx-auto mb-3" style="width: 80px; height: 80px;">
                                        <img src="@speaker.ResolvedImageUrl" 
                                             alt="@speaker.Name" 
                                             class="speaker-avatar rounded-circle w-100 h-100 object-fit-cover"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                        <div class="avatar-placeholder bg-@themeColorClass text-white" style="display: none; width: 100%; height: 100%;">
                                            <i class="bi bi-person-fill fs-1"></i>
                                        </div>
                                    </div>
                                    <h6 class="fw-bold mb-1">@speaker.Name</h6>
                                    <small class="text-muted d-block">@speaker.Title</small>
                                    @if (!string.IsNullOrEmpty(speaker.Company))
                                    {
                                        <small class="text-@themeColorClass">@speaker.Company</small>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</section>

<!-- 연사 상세 모달들 -->
@foreach (var speaker in speakers)
{
    var speakerSessions = sessions.Where(s => s.Speakers.Any(sp => sp.Id == speaker.Id)).ToList();
    <div class="modal fade" id="@speaker.ModalId" tabindex="-1" aria-labelledby="@(speaker.ModalId)-label" aria-hidden="true"
         data-speaker-hash="speaker-@speaker.Id">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body text-center pt-0">
                    <div class="speaker-avatar-wrapper mx-auto mb-3" style="width: 120px; height: 120px;">
                        <img src="@speaker.ResolvedImageUrl" 
                             alt="@speaker.Name" 
                             class="speaker-avatar rounded-circle w-100 h-100 object-fit-cover"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                        <div class="avatar-placeholder bg-@themeColorClass text-white" style="display: none; width: 100%; height: 100%;">
                            <i class="bi bi-person-fill" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                    <h4 class="fw-bold mb-1" id="@(speaker.ModalId)-label">@speaker.Name</h4>
                    <p class="text-muted mb-1">@speaker.Title</p>
                    @if (!string.IsNullOrEmpty(speaker.Company))
                    {
                        <p class="text-@themeColorClass fw-bold mb-3">@speaker.Company</p>
                    }
                    
                    @if (!string.IsNullOrEmpty(speaker.Bio))
                    {
                        <div class="text-start bg-light rounded p-3 mb-3">
                            <p class="mb-0" style="white-space: pre-line;">@speaker.Bio.Trim()</p>
                        </div>
                    }
                    
                    @if (speaker.HasSocialLinks)
                    {
                        <div class="d-flex justify-content-center gap-2 mb-3">
                            @if (!string.IsNullOrEmpty(speaker.GitHubUrl))
                            {
                                <a href="@speaker.GitHubUrl" target="_blank" class="btn btn-outline-dark btn-sm">
                                    <i class="bi bi-github"></i>
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(speaker.TwitterUrl))
                            {
                                <a href="@speaker.TwitterUrl" target="_blank" class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-twitter-x"></i>
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(speaker.LinkedInUrl))
                            {
                                <a href="@speaker.LinkedInUrl" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-linkedin"></i>
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(speaker.WebsiteUrl))
                            {
                                <a href="@speaker.WebsiteUrl" target="_blank" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-globe"></i>
                                </a>
                            }
                        </div>
                    }
                    
                    @if (speakerSessions.Count > 0)
                    {
                        <div class="text-start mt-4">
                            <h6 class="text-muted mb-3"><i class="bi bi-mic-fill me-1"></i>이 행사에서의 발표</h6>
                            <div class="d-flex flex-column gap-2">
                                @foreach (var session in speakerSessions)
                                {
                                    var trackInfo = SessionDisplay.GetFormatDisplayInfo(session.Format);
                                    <a href="?session=@session.Id" class="card border-0 bg-light text-decoration-none session-link-card">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <span class="badge bg-@trackInfo.BadgeColor small">@trackInfo.DisplayName</span>
                                                <span class="text-muted small">@(session.Duration.TotalMinutes)분</span>
                                            </div>
                                            <h6 class="fw-bold text-dark mb-1 small">@session.Title</h6>
                                            <p class="text-muted mb-0 small" style="font-size: 0.8rem;">@session.Description</p>
                                        </div>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer border-0 justify-content-center pt-0">
                    <button type="button" class="btn btn-secondary btn-copy-link" data-speaker-hash="@speaker.AnchorHash">
                        <i class="bi bi-link-45deg me-1"></i>링크 복사
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- 스토리 섹션 (있는 경우) -->
@if (yearData.Story != null)
{
    var story = yearData.Story;
    <section class="py-5 bg-light" id="story">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="text-center mb-5">
                        <h2 class="fw-bold display-5 mb-3">@story.Title</h2>
                        <p class="text-muted lead">@story.Subtitle</p>
                    </div>
                    
                    <div class="card border-0 shadow-lg">
                        <div class="card-body p-5">
                            @foreach (var (paragraph, index) in story.Paragraphs.Select((p, i) => (p, i)))
                            {
                                <p class="@(index == 0 ? "lead" : "text-muted") @(index < story.Paragraphs.Length - 1 ? "mb-4" : "mb-0")">
                                    @paragraph
                                </p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    @if (story.Highlights != null && story.Highlights.Length > 0)
    {
        <section class="py-5">
            <div class="container py-4">
                <div class="text-center mb-5">
                    <h2 class="fw-bold display-5 mb-3">@(evt.Year)년의 .NET</h2>
                    <p class="text-muted lead">당시 화두가 되었던 주제들</p>
                </div>
                <div class="row g-4 justify-content-center">
                    @foreach (var highlight in story.Highlights)
                    {
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center p-4">
                                    <div class="icon-box bg-@(themeColorClass)-subtle text-@themeColorClass mb-3">
                                        <i class="bi @highlight.Icon fs-1"></i>
                                    </div>
                                    <h5 class="card-title fw-bold">@highlight.Title</h5>
                                    <p class="card-text text-muted">@highlight.Description</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>
    }
}

<!-- 행사장 정보 -->
@if (evt.Type != EventType.Online && evt.HasVenues && evt.IsUpcoming)
{
    <section class="py-5" id="venue">
        <div class="container py-4">
            <div class="text-center mb-5">
                <h2 class="fw-bold display-5 mb-3">행사장 안내</h2>
                @if (evt.Venues.Count == 1)
                {
                    <p class="text-muted lead">@evt.PrimaryVenue!.Name</p>
                }
                else
                {
                    <p class="text-muted lead">@(evt.Venues.Count)개 장소에서 진행</p>
                }
            </div>
            
            @foreach (var venue in evt.Venues)
            {
                <div class="mb-5">
                    @if (evt.Venues.Count > 1)
                    {
                        <h4 class="fw-bold mb-4 text-center">
                            <i class="bi bi-building text-@themeColorClass me-2"></i>@venue.Name
                        </h4>
                    }
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <h5 class="fw-bold mb-3"><i class="bi bi-geo-alt text-@themeColorClass me-2"></i>위치</h5>
                                    <p class="text-muted mb-3">@venue.Address</p>
                                    
                                    @if (venue.HasMapLinks)
                                    {
                                        <div class="d-flex flex-wrap gap-2">
                                            @if (!string.IsNullOrEmpty(venue.NaverMapUrl))
                                            {
                                                <a href="@venue.NaverMapUrl" target="_blank" class="btn btn-outline-success btn-sm">
                                                    <i class="bi bi-map me-1"></i>네이버 지도
                                                </a>
                                            }
                                            @if (!string.IsNullOrEmpty(venue.KakaoMapUrl))
                                            {
                                                <a href="@venue.KakaoMapUrl" target="_blank" class="btn btn-outline-warning btn-sm">
                                                    <i class="bi bi-map me-1"></i>카카오 지도
                                                </a>
                                            }
                                            @if (!string.IsNullOrEmpty(venue.GoogleMapUrl))
                                            {
                                                <a href="@venue.GoogleMapUrl" target="_blank" class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-map me-1"></i>구글 지도
                                                </a>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            @if (venue.HasDirections)
                            {
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-4">
                                        <h5 class="fw-bold mb-3"><i class="bi bi-signpost-2 text-@themeColorClass me-2"></i>오시는 길</h5>
                                        <ul class="list-unstyled mb-0">
                                            @foreach (var direction in venue.Directions!)
                                            {
                                                <li class="mb-2">
                                                    <i class="bi bi-check-circle text-success me-2"></i>
                                                    <span class="text-muted">@direction</span>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        @if (venue.HasParkingInfo)
                        {
                            <div class="col-12">
                                <div class="card border-0 shadow-sm bg-light">
                                    <div class="card-body p-4">
                                        <h5 class="fw-bold mb-3"><i class="bi bi-p-circle text-@themeColorClass me-2"></i>주차 안내</h5>
                                        <p class="text-muted mb-0" style="white-space: pre-line;">@venue.ParkingInfo!.Trim()</p>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </section>
}

<!-- 스폰서 -->
@if (evt.HasSponsors)
{
    <section class="py-5 bg-light">
        <div class="container py-4">
            <div class="text-center mb-5">
                <h2 class="fw-bold display-5 mb-3">스폰서</h2>
                <p class="text-muted lead">행사를 후원해주신 파트너사</p>
            </div>
            
            @foreach (var tier in Enum.GetValues<SponsorTier>())
            {
                var tierSponsors = evt.Sponsors.GetByTier(tier).ToList();
                if (tierSponsors.Any())
                {
                    var tierColor = tier switch
                    {
                        SponsorTier.Platinum => "primary",
                        SponsorTier.Gold => "warning",
                        SponsorTier.Silver => "secondary",
                        SponsorTier.Bronze => "danger",
                        _ => "info"
                    };
                    var logoHeight = tier switch
                    {
                        SponsorTier.Platinum => "80px",
                        SponsorTier.Gold => "60px",
                        _ => "50px"
                    };
                    var colSize = tier switch
                    {
                        SponsorTier.Platinum => "col-md-6 col-lg-4",
                        SponsorTier.Gold => "col-md-4 col-lg-3",
                        _ => "col-6 col-md-3 col-lg-2"
                    };
                    <div class="mb-5">
                        <div class="text-center mb-4">
                            <span class="badge bg-@tierColor fs-6 px-3 py-2">@tier Sponsors</span>
                        </div>
                        <div class="row justify-content-center g-4">
                            @foreach (var sponsor in tierSponsors)
                            {
                                <div class="@colSize text-center">
                                    <a href="@sponsor.WebsiteUrl" target="_blank" class="text-decoration-none">
                                        <div class="card border-0 shadow-sm p-4 h-100 card-hover d-flex flex-column justify-content-center align-items-center" style="min-height: 120px;">
                                            <div class="sponsor-logo-wrapper d-flex align-items-center justify-content-center" style="width: 100%; height: @logoHeight;">
                                                <img src="@sponsor.ResolvedLogoUrl" 
                                                     alt="@sponsor.Name" 
                                                     class="sponsor-logo object-fit-contain"
                                                     style="max-width: 100%; max-height: 100%;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                                                <span class="text-muted fw-bold sponsor-name-fallback" style="display: none; font-size: 1.1rem;">@sponsor.Name</span>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </section>
}

<!-- 타임라인 -->
<section class="py-5">
    <div class="container py-4">
        <div class="text-center mb-5">
            <h2 class="fw-bold display-5 mb-3">.NET Universe 여정</h2>
            <p class="text-muted lead">2019년부터 현재까지</p>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="timeline">
                    @foreach (var item in Model.Timeline)
                    {
                        var isCurrentYear = item.Year == evt.Year;
                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                @if (isCurrentYear)
                                {
                                    <span class="badge bg-@item.ThemeColorClass @(item.ThemeColorClass == "warning" ? "text-dark" : "") fs-6 px-3 py-2">@item.Year</span>
                                }
                                else
                                {
                                    <a asp-page="/Years/Event" asp-route-year="@item.Year" class="badge bg-@item.ThemeColorClass @(item.ThemeColorClass == "warning" ? "text-dark" : "") fs-6 px-3 py-2 text-decoration-none">@item.Year</a>
                                }
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="fw-bold @(isCurrentYear ? "text-" + themeColorClass : "")">@item.Title</h6>
                                <p class="text-muted mb-0">@item.Description</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CTA -->
<section class="py-5 text-white" style="background-color: @themeColor;">
    <div class="container py-4 text-center">
        @if (Model.NextEvent != null)
        {
            <h2 class="fw-bold mb-3">다음 행사 보기</h2>
            <p class="lead opacity-90 mb-4">.NET Universe의 성장 과정을 확인하세요</p>
            <a href="/@Model.NextEvent.Slug" class="btn btn-light btn-lg">@Model.NextEvent.Event.Title 보기 →</a>
        }
        else if (Model.PreviousEvent != null)
        {
            <h2 class="fw-bold mb-3">이전 행사 보기</h2>
            <p class="lead opacity-90 mb-4">.NET Universe의 역사를 확인하세요</p>
            <a href="/@Model.PreviousEvent.Slug" class="btn btn-light btn-lg">← @Model.PreviousEvent.Event.Title 보기</a>
        }
        else
        {
            <h2 class="fw-bold mb-3">.NET Universe</h2>
            <p class="lead opacity-90 mb-4">함께 성장하는 .NET 커뮤니티</p>
            <a asp-page="/Index" class="btn btn-light btn-lg">홈으로 →</a>
        }
    </div>
</section>

@section Styles {
<style>
    .timetable-table {
        table-layout: fixed;
    }
    
    .timetable-table th,
    .timetable-table td {
        vertical-align: top;
    }
    
    .timetable-session {
        background: #fff;
        transition: all 0.2s ease;
        height: 100%;
    }
    
    .timetable-session:hover {
        background: #f8f9fa;
        box-shadow: inset 0 0 0 2px @themeColor;
    }
    
    .timetable-shared-session {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        vertical-align: middle !important;
    }
    
    .timetable-shared-session:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    
    .timetable-session-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        font-size: 0.9rem;
    }
    
    @@media (max-width: 768px) {
        .timetable-table {
            font-size: 0.85rem;
        }
        
        .timetable-session {
            padding: 0.5rem !important;
        }
        
        .timetable-session-title {
            font-size: 0.8rem;
        }
    }
</style>
}

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const sessionParam = urlParams.get('session');
        const speakerParam = urlParams.get('speaker');
        
        function openModalFromUrl() {
            if (sessionParam) {
                const modal = document.querySelector(`[data-session-hash="session-${sessionParam}"]`);
                if (modal) {
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                    return;
                }
            }
            if (speakerParam) {
                const modal = document.querySelector(`[data-speaker-hash="speaker-${speakerParam}"]`);
                if (modal) {
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                    return;
                }
            }
            
            const hash = window.location.hash;
            if (hash && hash.startsWith('#session-')) {
                const modal = document.querySelector(`[data-session-hash="${hash.substring(1)}"]`);
                if (modal) {
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                }
            } else if (hash && hash.startsWith('#speaker-')) {
                const modal = document.querySelector(`[data-speaker-hash="${hash.substring(1)}"]`);
                if (modal) {
                    const bsModal = new bootstrap.Modal(modal);
                    bsModal.show();
                }
            }
        }
        
        openModalFromUrl();
        window.addEventListener('hashchange', openModalFromUrl);
        
        document.querySelectorAll('.modal').forEach(function(modal) {
            modal.addEventListener('show.bs.modal', function() {
                const sessionHash = this.getAttribute('data-session-hash');
                const speakerHash = this.getAttribute('data-speaker-hash');
                if (sessionHash) {
                    const sessionId = sessionHash.replace('session-', '');
                    const newUrl = window.location.pathname + '?session=' + sessionId;
                    history.replaceState(null, null, newUrl);
                } else if (speakerHash) {
                    const speakerId = speakerHash.replace('speaker-', '');
                    const newUrl = window.location.pathname + '?speaker=' + speakerId;
                    history.replaceState(null, null, newUrl);
                }
            });
            
            modal.addEventListener('hide.bs.modal', function() {
                history.replaceState(null, null, window.location.pathname);
            });
        });
        
        document.querySelectorAll('.btn-copy-link[data-session-hash]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const sessionHash = this.getAttribute('data-session-hash');
                const sessionId = sessionHash.replace('#session-', '');
                const url = window.location.origin + window.location.pathname + '?session=' + sessionId;
                
                navigator.clipboard.writeText(url).then(function() {
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check me-1"></i>복사됨!';
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-success');
                    
                    setTimeout(function() {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-secondary');
                    }, 2000);
                });
            });
        });
        
        document.querySelectorAll('.btn-copy-link[data-speaker-hash]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const speakerHash = this.getAttribute('data-speaker-hash');
                const speakerId = speakerHash.replace('#speaker-', '');
                const url = window.location.origin + window.location.pathname + '?speaker=' + speakerId;
                
                navigator.clipboard.writeText(url).then(function() {
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check me-1"></i>복사됨!';
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-success');
                    
                    setTimeout(function() {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-secondary');
                    }, 2000);
                });
            });
        });
        
        document.querySelectorAll('.speaker-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                const speakerId = new URLSearchParams(href.split('?')[1]).get('speaker');
                
                if (speakerId) {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        const bsOpenModal = bootstrap.Modal.getInstance(openModal);
                        if (bsOpenModal) {
                            bsOpenModal.hide();
                        }
                    }
                    
                    setTimeout(function() {
                        const speakerModal = document.querySelector(`[data-speaker-hash="speaker-${speakerId}"]`);
                        if (speakerModal) {
                            const bsModal = new bootstrap.Modal(speakerModal);
                            bsModal.show();
                        }
                    }, 300);
                }
            });
        });
        
        document.querySelectorAll('.session-link-card').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                const sessionId = new URLSearchParams(href.split('?')[1]).get('session');
                
                if (sessionId) {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        const bsOpenModal = bootstrap.Modal.getInstance(openModal);
                        if (bsOpenModal) {
                            bsOpenModal.hide();
                        }
                    }
                    
                    setTimeout(function() {
                        const sessionModal = document.querySelector(`[data-session-hash="session-${sessionId}"]`);
                        if (sessionModal) {
                            const bsModal = new bootstrap.Modal(sessionModal);
                            bsModal.show();
                        }
                    }, 300);
                }
            });
        });
        
        // 세션 카드 클릭 핸들러 - 카드 영역 클릭 시 모달 열기, 링크 클릭 시 제외
        document.querySelectorAll('.session-card').forEach(function(card) {
            card.addEventListener('click', function(e) {
                // 링크나 버튼 클릭인 경우 모달을 열지 않음
                if (e.target.closest('.session-card-link')) {
                    return;
                }
                
                const modalTarget = this.getAttribute('data-modal-target');
                if (modalTarget) {
                    const modal = document.querySelector(modalTarget);
                    if (modal) {
                        const bsModal = new bootstrap.Modal(modal);
                        bsModal.show();
                    }
                }
            });
        });
        
        // 인라인 비디오 플레이어 핸들러
        document.querySelectorAll('.video-play-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const card = this.closest('.session-card');
                const videoContainer = card.querySelector('.video-player-container');
                const iframe = videoContainer.querySelector('.video-iframe');
                const actionButtons = card.querySelector('.session-action-buttons');
                
                // iframe에 src 설정 (매번 새로 설정하여 재생 보장)
                if (iframe.dataset.src) {
                    iframe.src = iframe.dataset.src;
                }
                
                // 비디오 컨테이너 표시, 버튼 숨기기
                videoContainer.style.display = 'block';
                actionButtons.style.display = 'none';
            });
        });
        
        // 비디오 닫기 버튼 핸들러
        document.querySelectorAll('.video-close-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const card = this.closest('.session-card');
                const videoContainer = card.querySelector('.video-player-container');
                const iframe = videoContainer.querySelector('.video-iframe');
                const actionButtons = card.querySelector('.session-action-buttons');
                
                // 비디오 정지 (src를 about:blank로 설정하여 완전히 정지)
                iframe.src = 'about:blank';
                
                // 비디오 컨테이너 숨기기, 버튼 다시 표시
                videoContainer.style.display = 'none';
                actionButtons.style.display = 'flex';
            });
        });
    });
</script>
}
